#!/bin/sh

# –í–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π —Ä–µ–∂–∏–º (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å, —É–¥–∞–ª–∏–≤ –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–≤ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É)
#set -x

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
RED='\033[0;31m'      # –ö—Ä–∞—Å–Ω—ã–π
GREEN='\033[0;32m'    # –ó–µ–ª—ë–Ω—ã–π
YELLOW='\033[0;33m'   # –ñ—ë–ª—Ç—ã–π
BLUE='\033[38;5;208m'     # –û—Ä–∞–Ω–∂
NC='\033[0m'          # –ë–µ–∑ –¶–≤–µ—Ç–∞

# –§–∞–π–ª—ã –∏ –ø—É—Ç–∏
SERVER_LIST="/etc/init.d/servers.txt"
CONFIG_FILE="/etc/sing-box/config.json"
SERVER_PARAMS_FILE="/etc/init.d/servers_config.json"
LOG_FILE="/tmp/ping_log.txt"

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
info() {
    echo -e "${BLUE}$1${NC}" | tee -a "$LOG_FILE"
}

success() {
    echo -e "${GREEN}$1${NC}" | tee -a "$LOG_FILE"
}

warning() {
    echo -e "${YELLOW}$1${NC}" | tee -a "$LOG_FILE"
}

error() {
    echo -e "${RED}$1${NC}" | tee -a "$LOG_FILE"
}

start() {
    info "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤..."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
    if [ ! -f "$SERVER_LIST" ]; then
        error "‚ùå –§–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–æ–≤ $SERVER_LIST –Ω–µ –Ω–∞–π–¥–µ–Ω."
        exit 1
    fi

    if [ ! -f "$SERVER_PARAMS_FILE" ]; then
        error "‚ùå –§–∞–π–ª —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ $SERVER_PARAMS_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω."
        exit 1
    fi

    best_server=""
    best_average=9999 # –ù–∞—á–∞–ª—å–Ω–æ–µ –≤—ã—Å–æ–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å—á—ë—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω—ã—Ö –ø–∏–Ω–≥–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
    while read -r server; do
        info "üì° –ü–∏–Ω–≥—É–µ–º —Å–µ—Ä–≤–µ—Ä: $server..."
        total_time=0
        success_count=0

        for i in $(seq 1 10); do
            # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∏–Ω–≥ –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –≤—Ä–µ–º–µ–Ω–µ–º –æ—Ç–≤–µ—Ç–∞
            ping_output=$(ping -c 1 -W 1 "$server" | grep 'time=')
            if [ -n "$ping_output" ]; then
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
                time=$(echo "$ping_output" | awk -F'time=' '{print $2}' | awk '{print $1}')

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º
                if echo "$time" | grep -E '^[0-9.]+$' >/dev/null 2>&1; then
                    # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫ –æ–±—â–µ–π —Å—É–º–º–µ
                    total_time=$(awk "BEGIN {printf \"%.2f\", $total_time + $time}")
                    success_count=$((success_count + 1))
                    success "‚úÖ –ü–æ–ø—ã—Ç–∫–∞ $i: $time –º—Å"
                else
                    warning "‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ $i: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞."
                fi
            else
                warning "‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ $i: –ü–∏–Ω–≥ –Ω–µ —É–¥–∞–ª—Å—è."
            fi
        done

        if [ "$success_count" -gt 0 ]; then
            # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            info "üìä total_time: $total_time"
            info "üî¢ success_count: $success_count"

            # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
            average_time=$(awk "BEGIN {printf \"%.2f\", $total_time / $success_count}")
            success "üìà –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –¥–ª—è $server: $average_time –º—Å (–£—Å–ø–µ—à–Ω—ã—Ö –ø–∏–Ω–≥–æ–≤: $success_count)"

            # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å —Ç–µ–∫—É—â–∏–º –ª—É—á—à–∏–º
            better=$(echo "$average_time < $best_average" | bc)
            if [ "$better" -eq 1 ]; then
                best_average=$average_time
                best_server=$server
                success "üåü –ù–æ–≤—ã–π –ª—É—á—à–∏–π —Å–µ—Ä–≤–µ—Ä: $best_server —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º $best_average –º—Å"
            fi
        else
            warning "‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä $server –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ 10 –ø–æ–ø—ã—Ç–æ–∫."
        fi

    done < "$SERVER_LIST"

    if [ -n "$best_server" ]; then
        success "üèÜ –õ—É—á—à–∏–π —Å–µ—Ä–≤–µ—Ä: $best_server —Å–æ —Å—Ä–µ–¥–Ω–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –æ—Ç–≤–µ—Ç–∞ $best_average –º—Å"

        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        server_params=$(jq ".servers[] | select(.server == \"$best_server\")" "$SERVER_PARAMS_FILE")

        # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
        info "üìÑ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:"
        echo "$server_params" | tee -a "$LOG_FILE"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ server_params —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON
        if ! echo "$server_params" | jq empty > /dev/null 2>&1; then
            error "‚ùå –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ä–≤–µ—Ä–∞ $best_server —Å–æ–¥–µ—Ä–∂–∞—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON."
            exit 1
        fi

        if [ -z "$server_params" ]; then
            error "‚ùå –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ $best_server –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            exit 1
        fi

        # **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        current_server=$(jq -r '.outbounds[0].server' "$CONFIG_FILE")
        if [ "$current_server" = "$best_server" ]; then
            success "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª—É—á—à–∏–π —Å–µ—Ä–≤–µ—Ä: $best_server. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
        else
            warning "‚ö†Ô∏è –¢–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä: $current_server –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª—É—á—à–µ–º—É —Å–µ—Ä–≤–µ—Ä—É: $best_server. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ."

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª, –∑–∞–º–µ–Ω—è—è —Ä–∞–∑–¥–µ–ª outbounds –Ω–æ–≤—ã–º –º–∞—Å—Å–∏–≤–æ–º
            echo "$server_params" | jq -s '.[0]' > /tmp/best_server.json
            jq --slurpfile params /tmp/best_server.json '.outbounds = $params' "$CONFIG_FILE" > /tmp/temp_config.json

            if [ $? -ne 0 ]; then
                error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞."
                exit 1
            fi

            mv /tmp/temp_config.json "$CONFIG_FILE"
            success "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω."

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—É sing-box
            info "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã sing-box..."
            service sing-box restart

            # –ñ–¥–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è IP-–∞–¥—Ä–µ—Å–∞ –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ tun0
            info "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è IP-–∞–¥—Ä–µ—Å–∞ –Ω–∞ tun0..."
            for i in $(seq 1 30); do
                if ip addr show tun0 | grep -q "inet "; then
                    success "üü¢ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å tun0 –ø–æ–ª—É—á–∏–ª IP-–∞–¥—Ä–µ—Å."
                    break
                fi
                info "üîÑ –û–∂–∏–¥–∞–Ω–∏–µ... ($i/30)"
                sleep 2
            done

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ IP-–∞–¥—Ä–µ—Å–∞ –Ω–∞ tun0
            if ip addr show tun0 | grep -q "inet "; then
                success "‚úÖ tun0 –∞–∫—Ç–∏–≤–µ–Ω –∏ –∏–º–µ–µ—Ç IP-–∞–¥—Ä–µ—Å:"
                ip addr show tun0 | grep "inet " | tee -a "$LOG_FILE"
            else
                error "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω IP-–∞–¥—Ä–µ—Å –Ω–∞ tun0. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é."
            fi
        fi

    else
        error "‚ùå –í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."
    fi
}

case "$1" in
    start)
        start
        ;;
    *)
        echo -e "${YELLOW}‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {start}${NC}" | tee -a "$LOG_FILE"
        exit 1
        ;;
esac